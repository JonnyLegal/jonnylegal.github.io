<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DJ Legal's Chord Machine</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f13;
      --surface: #1a1a24;
      --surface2: #22222f;
      --border: #2e2e42;
      --accent: #7c6af7;
      --accent2: #a78bfa;
      --accent3: #f472b6;
      --text: #e2e2f0;
      --text-muted: #7c7c9a;
      --success: #34d399;
      --warn: #fbbf24;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem 1rem;
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent2), var(--accent3));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.3rem;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.5rem;
      width: 100%;
      max-width: 720px;
      margin-bottom: 1.25rem;
    }

    .card-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1rem;
    }

    @media (max-width: 520px) {
      .controls { grid-template-columns: 1fr 1fr; }
    }

    label {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 500;
    }

    select, input[type="range"] {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      padding: 0.5rem 0.75rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s;
      appearance: none;
      -webkit-appearance: none;
    }

    select:focus, select:hover { border-color: var(--accent); outline: none; }

    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237c7c9a' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2rem;
    }

    input[type="range"] {
      padding: 0;
      height: 36px;
      accent-color: var(--accent);
    }

    .range-row { display: flex; align-items: center; gap: 0.5rem; }
    .range-val {
      font-size: 0.85rem;
      color: var(--accent2);
      font-weight: 600;
      min-width: 38px;
      text-align: right;
    }

    /* Action buttons */
    .actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.65rem 1.4rem;
      transition: transform 0.12s, opacity 0.2s, box-shadow 0.2s;
    }

    button:active { transform: scale(0.96); }
    button:disabled { opacity: 0.45; cursor: not-allowed; }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent3));
      color: #fff;
      box-shadow: 0 4px 20px rgba(124, 106, 247, 0.35);
    }
    .btn-primary:hover:not(:disabled) { box-shadow: 0 4px 28px rgba(124, 106, 247, 0.55); }

    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover:not(:disabled) { border-color: var(--accent); }

    .btn-stop {
      background: #3f1f2e;
      color: var(--accent3);
      border: 1px solid #7f2e52;
    }
    .btn-stop:hover:not(:disabled) { background: #5a1f38; }

    /* Progression display */
    .progression-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 0.75rem;
      min-height: 80px;
    }

    .chord-card {
      background: var(--surface2);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 0.85rem 0.75rem;
      text-align: center;
      position: relative;
      transition: border-color 0.15s, transform 0.15s, box-shadow 0.15s;
      cursor: pointer;
    }

    .chord-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(124,106,247,0.2);
    }

    .chord-card.playing {
      border-color: var(--success);
      box-shadow: 0 0 20px rgba(52, 211, 153, 0.3);
      transform: translateY(-3px);
    }

    .chord-card.queued {
      border-color: var(--warn);
    }

    .chord-numeral {
      font-size: 0.72rem;
      color: var(--text-muted);
      font-weight: 600;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .chord-name {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.2rem;
      letter-spacing: -0.3px;
    }

    .chord-quality {
      font-size: 0.72rem;
      color: var(--accent2);
      font-weight: 500;
    }

    .chord-notes {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 0.3rem;
    }

    .play-indicator {
      position: absolute;
      top: 6px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 0.7s ease-in-out infinite alternate;
      display: none;
    }

    .chord-card.playing .play-indicator { display: block; }

    @keyframes pulse {
      from { opacity: 0.4; transform: scale(0.8); }
      to   { opacity: 1;   transform: scale(1.2); }
    }

    /* Info bar */
    .info-bar {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.3rem 0.65rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .badge span { color: var(--accent2); font-weight: 600; }

    .status {
      margin-left: auto;
      font-size: 0.8rem;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Waveform / progress bar */
    .progress-bar {
      width: 100%;
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 0.75rem;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent3));
      border-radius: 2px;
      width: 0%;
      transition: width 0.1s linear;
    }

    /* Preset chips */
    .preset-list {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .preset-chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.3rem 0.85rem;
      font-size: 0.78rem;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      font-weight: 500;
    }

    .preset-chip:hover { border-color: var(--accent); color: var(--accent2); }
    .preset-chip.active { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* Piano keyboard visualization */
    .piano-wrap {
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }

    .piano {
      display: flex;
      position: relative;
      height: 80px;
      gap: 2px;
      min-width: fit-content;
    }

    .key {
      border-radius: 0 0 5px 5px;
      cursor: default;
      transition: background 0.15s;
    }

    .key.white {
      width: 32px;
      height: 80px;
      background: #d8d8e8;
      border: 1px solid #888;
      z-index: 1;
    }

    .key.black {
      width: 20px;
      height: 50px;
      background: #1a1a2e;
      border: 1px solid #555;
      margin-left: -10px;
      margin-right: -10px;
      z-index: 2;
    }

    .key.lit-chord { background: var(--accent) !important; }
    .key.lit-root  { background: var(--accent3) !important; }

    .empty-state {
      color: var(--text-muted);
      font-size: 0.85rem;
      text-align: center;
      padding: 1rem 0;
      grid-column: 1/-1;
    }

    /* Genre description */
    .genre-desc {
      font-size: 0.82rem;
      color: var(--text-muted);
      line-height: 1.5;
      margin-bottom: 0.75rem;
      padding: 0.6rem 0.85rem;
      background: var(--surface2);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }

    .genre-desc strong { color: var(--accent2); }

    .genre-tags {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.4rem;
    }

    .genre-tag {
      background: rgba(124,106,247,0.15);
      border: 1px solid rgba(124,106,247,0.3);
      border-radius: 12px;
      padding: 0.15rem 0.55rem;
      font-size: 0.68rem;
      color: var(--accent2);
      font-weight: 500;
    }

    /* Effects */
    .fx-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }

    @media (max-width: 520px) {
      .fx-grid { grid-template-columns: 1fr; }
    }

    .fx-section-title {
      font-size: 0.72rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--accent2);
      margin-bottom: 0.65rem;
      padding-bottom: 0.35rem;
      border-bottom: 1px solid var(--border);
    }

    .fx-row {
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      margin-bottom: 0.6rem;
    }

    .fx-row label {
      flex-direction: row;
      align-items: center;
      gap: 0;
      font-size: 0.75rem;
    }

    .fx-row .range-row {
      width: 100%;
    }

    .fx-row .range-row input[type="range"] {
      flex: 1;
    }
  </style>
</head>
<body>

<h1>DJ Legal's Chord Machine</h1>
<p class="subtitle">Build & preview chord progressions in any key</p>

<!-- Controls -->
<div class="card">
  <div class="card-title">Settings</div>
  <div class="controls">
    <label>
      Genre
      <select id="genre">
        <option value="all">All Genres</option>
        <option value="melodicHouse">Melodic House</option>
        <option value="melodicTechno">Melodic Techno</option>
        <option value="deepHouse">Deep House</option>
        <option value="progressiveHouse">Progressive House</option>
      </select>
    </label>

    <label>
      Root Key
      <select id="rootKey">
        <option value="C">C</option>
        <option value="C#">C# / Db</option>
        <option value="D">D</option>
        <option value="D#">D# / Eb</option>
        <option value="E">E</option>
        <option value="F">F</option>
        <option value="F#">F# / Gb</option>
        <option value="G">G</option>
        <option value="G#">G# / Ab</option>
        <option value="A">A</option>
        <option value="A#">A# / Bb</option>
        <option value="B">B</option>
      </select>
    </label>

    <label>
      Scale
      <select id="scale">
        <option value="major">Major</option>
        <option value="minor">Natural Minor</option>
        <option value="dorian">Dorian</option>
        <option value="mixolydian">Mixolydian</option>
        <option value="harmonicMinor">Harmonic Minor</option>
      </select>
    </label>

    <label>
      Voicing
      <select id="voicing">
        <option value="triad">Triads</option>
        <option value="seventh">7th Chords</option>
        <option value="sus2">Sus2</option>
        <option value="sus4">Sus4</option>
      </select>
    </label>

    <label>
      Tempo (BPM)
      <div class="range-row">
        <input type="range" id="tempo" min="40" max="180" value="90" />
        <span class="range-val" id="tempoVal">90</span>
      </div>
    </label>

    <label>
      Octave
      <select id="octave">
        <option value="3">Low (3)</option>
        <option value="4" selected>Mid (4)</option>
        <option value="5">High (5)</option>
      </select>
    </label>

    <label>
      Instrument
      <select id="instrument">
        <option value="pluckBright">Pluck — Bright</option>
        <option value="pluckMuted">Pluck — Muted</option>
        <option value="padWarm" selected>Pad — Warm</option>
        <option value="padLush">Pad — Lush</option>
        <option value="keysElectric">Keys — Electric</option>
        <option value="keysBell">Keys — Bell</option>
      </select>
    </label>

    <label>
      Length
      <select id="progLength">
        <option value="4" selected>4 bars</option>
        <option value="8">8 bars</option>
      </select>
    </label>

    <label>
      Groove
      <select id="groove">
        <option value="straight">Straight</option>
        <option value="stab">Stab</option>
        <option value="halfBar">Half Bar</option>
        <option value="offbeat">Offbeat</option>
        <option value="pump">Pump</option>
      </select>
    </label>
  </div>
</div>

<!-- Presets -->
<div class="card">
  <div class="card-title">Progressions</div>
  <div class="genre-desc" id="genreDesc" style="display:none;"></div>
  <div class="preset-list" id="presetList"></div>
</div>

<!-- Progression Display -->
<div class="card">
  <div class="card-title">Progression</div>
  <div class="info-bar" id="infoBar" style="margin-bottom:0.85rem;">
    <div class="badge">Genre: <span id="genreDisplay">—</span></div>
    <div class="badge">Key: <span id="keyDisplay">—</span></div>
    <div class="badge">Scale: <span id="scaleDisplay">—</span></div>
    <div class="badge">Chords: <span id="chordCount">—</span></div>
    <div class="status" id="statusText">Generate a progression to begin</div>
  </div>
  <div class="progression-grid" id="progressionGrid">
    <div class="empty-state">No progression generated yet. Hit "Generate" or pick a preset.</div>
  </div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
</div>

<!-- Piano -->
<div class="card">
  <div class="card-title">Piano Keyboard — highlighted notes for selected chord</div>
  <div class="piano-wrap">
    <div class="piano" id="piano"></div>
  </div>
</div>

<!-- Effects -->
<div class="card">
  <div class="card-title">Effects</div>
  <div class="fx-grid">
    <div>
      <div class="fx-section-title">Delay</div>
      <div class="fx-row">
        <label>Mix</label>
        <div class="range-row">
          <input type="range" id="delayMix" min="0" max="100" value="0" />
          <span class="range-val" id="delayMixVal">0%</span>
        </div>
      </div>
      <div class="fx-row">
        <label>Time</label>
        <div class="range-row">
          <input type="range" id="delayTime" min="50" max="800" value="300" />
          <span class="range-val" id="delayTimeVal">300ms</span>
        </div>
      </div>
      <div class="fx-row">
        <label>Feedback</label>
        <div class="range-row">
          <input type="range" id="delayFeedback" min="0" max="85" value="30" />
          <span class="range-val" id="delayFeedbackVal">30%</span>
        </div>
      </div>
    </div>
    <div>
      <div class="fx-section-title">Reverb</div>
      <div class="fx-row">
        <label>Mix</label>
        <div class="range-row">
          <input type="range" id="reverbMix" min="0" max="100" value="0" />
          <span class="range-val" id="reverbMixVal">0%</span>
        </div>
      </div>
      <div class="fx-row">
        <label>Size</label>
        <div class="range-row">
          <input type="range" id="reverbSize" min="1" max="10" value="5" />
          <span class="range-val" id="reverbSizeVal">5</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Actions -->
<div class="card">
  <div class="actions">
    <button class="btn-primary" id="btnGenerate">Generate Progression</button>
    <button class="btn-primary" id="btnPlay" disabled>&#9654; Play All</button>
    <button class="btn-stop"  id="btnStop" disabled>&#9646;&#9646; Stop</button>
    <button class="btn-secondary" id="btnShuffle">Shuffle Key &amp; Scale</button>
  </div>
</div>

<script>
// ─── Music Theory Data ────────────────────────────────────────────────────────

const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const ENHARMONICS = {
  'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb'
};

// Scale intervals (semitones from root)
const SCALES = {
  major:        { steps: [0,2,4,5,7,9,11], name: 'Major' },
  minor:        { steps: [0,2,3,5,7,8,10], name: 'Natural Minor' },
  dorian:       { steps: [0,2,3,5,7,9,10], name: 'Dorian' },
  mixolydian:   { steps: [0,2,4,5,7,9,10], name: 'Mixolydian' },
  harmonicMinor:{ steps: [0,2,3,5,7,8,11], name: 'Harmonic Minor' },
};

// Chord quality from triad intervals
function triadQuality(steps, degree) {
  const s = steps;
  const i = degree;
  const root = s[i % 7];
  const third = s[(i+2) % 7] + (Math.floor((i+2)/7)*12);
  const fifth  = s[(i+4) % 7] + (Math.floor((i+4)/7)*12);
  const t3 = ((third - root) + 12) % 12;
  const t5 = ((fifth  - root) + 12) % 12;
  if (t3 === 4 && t5 === 7) return { quality: '', label: 'Major', intervals: [0,4,7] };
  if (t3 === 3 && t5 === 7) return { quality: 'm', label: 'Minor', intervals: [0,3,7] };
  if (t3 === 3 && t5 === 6) return { quality: 'dim', label: 'Diminished', intervals: [0,3,6] };
  if (t3 === 4 && t5 === 8) return { quality: 'aug', label: 'Augmented', intervals: [0,4,8] };
  return { quality: '', label: 'Major', intervals: [0,4,7] };
}

function seventhQuality(steps, degree) {
  const t = triadQuality(steps, degree);
  const s = steps;
  const i = degree;
  const root   = s[i % 7];
  const seventh = s[(i+6) % 7] + (Math.floor((i+6)/7)*12);
  const t7 = ((seventh - root) + 12) % 12;
  if (t.quality === '' && t7 === 11) return { quality: 'maj7', label: 'Major 7th', intervals: [0,4,7,11] };
  if (t.quality === '' && t7 === 10) return { quality: '7',    label: 'Dominant 7th', intervals: [0,4,7,10] };
  if (t.quality === 'm' && t7 === 10) return { quality: 'm7',   label: 'Minor 7th', intervals: [0,3,7,10] };
  if (t.quality === 'm' && t7 === 11) return { quality: 'mmaj7',label: 'Minor-Major 7th', intervals: [0,3,7,11] };
  if (t.quality === 'dim' && t7 === 9) return { quality: 'm7b5', label: 'Half-Diminished', intervals: [0,3,6,9] };
  if (t.quality === 'dim' && t7 === 10)return { quality: 'dim7', label: 'Diminished 7th', intervals: [0,3,6,9] };
  return { ...t, intervals: t.intervals };
}

function sus2Quality() { return { quality: 'sus2', label: 'Suspended 2nd', intervals: [0,2,7] }; }
function sus4Quality() { return { quality: 'sus4', label: 'Suspended 4th', intervals: [0,5,7] }; }

const ROMAN = ['I','II','III','IV','V','VI','VII'];

function buildChord(rootNote, degree, scaleKey, voicingType, octave) {
  const scale = SCALES[scaleKey];
  const steps = scale.steps;
  const rootIdx = NOTE_NAMES.indexOf(rootNote);

  let qInfo;
  if      (voicingType === 'seventh') qInfo = seventhQuality(steps, degree);
  else if (voicingType === 'sus2')    qInfo = sus2Quality();
  else if (voicingType === 'sus4')    qInfo = sus4Quality();
  else                                qInfo = triadQuality(steps, degree);

  // Root note of this chord
  const chordRootSemi = (rootIdx + steps[degree]) % 12;
  const chordRootName = NOTE_NAMES[chordRootSemi];

  // Determine roman numeral case
  const isMinorLike = qInfo.quality.startsWith('m') || qInfo.quality === 'dim' || qInfo.quality === 'dim7' || qInfo.quality === 'm7b5';
  const roman = isMinorLike ? ROMAN[degree].toLowerCase() : ROMAN[degree];

  // Compute actual MIDI-ish pitches (semitone offset from C0)
  const baseOct = parseInt(octave, 10);
  const rootMidi = rootIdx + baseOct * 12 + steps[degree];

  const pitches = qInfo.intervals.map(interval => rootMidi + interval);
  const noteNames = pitches.map(p => NOTE_NAMES[((p % 12) + 12) % 12]);

  return {
    roman,
    chordRootName,
    quality: qInfo.quality,
    label: qInfo.label,
    noteNames,
    pitches,
    degree,
  };
}

// ─── Genre metadata ─────────────────────────────────────────────────────────

const GENRES = {
  all: {
    name: 'All Genres',
    desc: null,
    defaults: {},
  },
  melodicHouse: {
    name: 'Melodic House',
    desc: 'Emotional, uplifting progressions with warm pads and driving beats. Often uses <strong>minor keys</strong> that resolve to major chords for that signature euphoric lift.',
    tags: ['120–128 BPM', 'Emotional', 'Uplifting', 'Minor → Major'],
    defaults: { scale: 'minor', tempo: 124, voicing: 'seventh', instrument: 'padLush' },
  },
  melodicTechno: {
    name: 'Melodic Techno',
    desc: 'Dark, atmospheric, and hypnotic. Relies on <strong>unresolved minor progressions</strong> that create tension and space. Sparse chords let the rhythm breathe.',
    tags: ['122–130 BPM', 'Dark', 'Hypnotic', 'Atmospheric'],
    defaults: { scale: 'minor', tempo: 126, voicing: 'triad', instrument: 'padWarm' },
  },
  deepHouse: {
    name: 'Deep House',
    desc: 'Warm, soulful, and jazzy. Borrows from <strong>jazz and soul harmony</strong> — 7th chords, smooth ii–V motions, and laid-back grooves.',
    tags: ['118–125 BPM', 'Soulful', 'Jazzy', 'Warm'],
    defaults: { scale: 'dorian', tempo: 122, voicing: 'seventh', instrument: 'keysElectric' },
  },
  progressiveHouse: {
    name: 'Progressive House',
    desc: 'Building, evolving, and epic. Long progressions that <strong>build tension</strong> across sections, resolving in euphoric drops and anthemic melodies.',
    tags: ['126–132 BPM', 'Building', 'Epic', 'Anthemic'],
    defaults: { scale: 'minor', tempo: 128, voicing: 'triad', instrument: 'padLush' },
  },
};

// ─── Preset progressions (by degree index), tagged by genre ─────────────────

const PRESETS = [
  // ── Melodic House — 4 bar ──
  { name: 'i–III–VII–VI',   label: 'Emotional Lift',     degrees: [0,2,6,5],    genre: 'melodicHouse',      bars: 4 },
  { name: 'i–IV–VII–III',   label: 'Uplifting Drive',    degrees: [0,3,6,2],    genre: 'melodicHouse',      bars: 4 },
  { name: 'vi–IV–I–V',      label: 'Anthemic',           degrees: [5,3,0,4],    genre: 'melodicHouse',      bars: 4 },
  { name: 'i–VI–III–VII',   label: 'Dreamy',             degrees: [0,5,2,6],    genre: 'melodicHouse',      bars: 4 },
  { name: 'i–iv–VII–III',   label: 'Melancholic',        degrees: [0,3,6,2],    genre: 'melodicHouse',      bars: 4 },
  { name: 'I–V–vi–IV',      label: 'Feel-Good',          degrees: [0,4,5,3],    genre: 'melodicHouse',      bars: 4 },

  // ── Melodic House — 8 bar ──
  { name: 'i–III–VII–VI–iv–VI–III–I',    label: 'Sunrise Journey',   degrees: [0,2,6,5,3,5,2,0],   genre: 'melodicHouse',      bars: 8 },
  { name: 'vi–IV–I–V–ii–IV–I–V',        label: 'Heartbeat',         degrees: [5,3,0,4,1,3,0,4],   genre: 'melodicHouse',      bars: 8 },
  { name: 'i–VI–IV–VII–III–VI–I–V',     label: 'Lost & Found',      degrees: [0,5,3,6,2,5,0,4],   genre: 'melodicHouse',      bars: 8 },

  // ── Melodic Techno — 4 bar ──
  { name: 'i–VII–VI–VII',   label: 'Driving',            degrees: [0,6,5,6],    genre: 'melodicTechno',     bars: 4 },
  { name: 'i–iv–v–i',       label: 'Dark Loop',          degrees: [0,3,4,0],    genre: 'melodicTechno',     bars: 4 },
  { name: 'i–III–VII–VI',   label: 'Brooding',           degrees: [0,2,6,5],    genre: 'melodicTechno',     bars: 4 },
  { name: 'i–VI–iv–VII',    label: 'Atmospheric',        degrees: [0,5,3,6],    genre: 'melodicTechno',     bars: 4 },
  { name: 'i–VII–iv–III',   label: 'Tension',            degrees: [0,6,3,2],    genre: 'melodicTechno',     bars: 4 },
  { name: 'i–v–iv–VII',     label: 'Hypnotic',           degrees: [0,4,3,6],    genre: 'melodicTechno',     bars: 4 },

  // ── Melodic Techno — 8 bar ──
  { name: 'i–VII–iv–VII–i–VI–iv–VII',   label: 'Void Walker',       degrees: [0,6,3,6,0,5,3,6],   genre: 'melodicTechno',     bars: 8 },
  { name: 'i–iv–v–i–III–VII–VI–VII',    label: 'Static Mind',       degrees: [0,3,4,0,2,6,5,6],   genre: 'melodicTechno',     bars: 8 },
  { name: 'i–VII–VI–iv–III–VII–VI–i',   label: 'The Current',       degrees: [0,6,5,3,2,6,5,0],   genre: 'melodicTechno',     bars: 8 },

  // ── Deep House — 4 bar ──
  { name: 'ii–V–I–vi',      label: 'Jazzy Groove',       degrees: [1,4,0,5],    genre: 'deepHouse',         bars: 4 },
  { name: 'I–vi–ii–V',      label: 'Soulful',            degrees: [0,5,1,4],    genre: 'deepHouse',         bars: 4 },
  { name: 'i–IV–VII–III',   label: 'Deep Groove',        degrees: [0,3,6,2],    genre: 'deepHouse',         bars: 4 },
  { name: 'vi–ii–V–I',      label: 'Smooth',             degrees: [5,1,4,0],    genre: 'deepHouse',         bars: 4 },
  { name: 'i–VII–III–VI',   label: 'Warm Minor',         degrees: [0,6,2,5],    genre: 'deepHouse',         bars: 4 },
  { name: 'I–III–vi–IV',    label: 'Chill',              degrees: [0,2,5,3],    genre: 'deepHouse',         bars: 4 },

  // ── Deep House — 8 bar ──
  { name: 'ii–V–I–vi–ii–IV–iii–VI',     label: 'After Dark',        degrees: [1,4,0,5,1,3,2,5],   genre: 'deepHouse',         bars: 8 },
  { name: 'I–vi–ii–V–I–IV–ii–V',        label: 'Soul Circuit',      degrees: [0,5,1,4,0,3,1,4],   genre: 'deepHouse',         bars: 8 },
  { name: 'i–IV–VII–III–VI–III–VII–III', label: '3am Groove',       degrees: [0,3,6,2,5,2,6,2],   genre: 'deepHouse',         bars: 8 },

  // ── Progressive House — 4 bar ──
  { name: 'vi–IV–I–V',      label: 'Anthem Build',       degrees: [5,3,0,4],    genre: 'progressiveHouse',  bars: 4 },
  { name: 'I–V–vi–IV',      label: 'Classic Build',      degrees: [0,4,5,3],    genre: 'progressiveHouse',  bars: 4 },
  { name: 'i–III–VII–IV',   label: 'Progressive Rise',   degrees: [0,2,6,3],    genre: 'progressiveHouse',  bars: 4 },
  { name: 'i–VII–VI–V',     label: 'Dramatic',           degrees: [0,6,5,4],    genre: 'progressiveHouse',  bars: 4 },
  { name: 'I–IV–vi–V',      label: 'Uplifting',          degrees: [0,3,5,4],    genre: 'progressiveHouse',  bars: 4 },
  { name: 'vi–I–V–IV',      label: 'Euphoric',           degrees: [5,0,4,3],    genre: 'progressiveHouse',  bars: 4 },

  // ── Progressive House — 8 bar ──
  { name: 'vi–IV–I–V–vi–II–IV–I',       label: 'Stratosphere',      degrees: [5,3,0,4,5,1,3,0],   genre: 'progressiveHouse',  bars: 8 },
  { name: 'i–III–VII–IV–VI–IV–I–V',     label: 'Ignition',          degrees: [0,2,6,3,5,3,0,4],   genre: 'progressiveHouse',  bars: 8 },
  { name: 'I–V–vi–IV–I–V–II–IV',        label: 'Overture',          degrees: [0,4,5,3,0,4,1,3],   genre: 'progressiveHouse',  bars: 8 },
];

// ─── Web Audio ───────────────────────────────────────────────────────────────

let audioCtx = null;
function getCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function midiToFreq(midi) {
  // midi 0 = C0, A4 = 69 = 440Hz
  return 440 * Math.pow(2, (midi - 57) / 12);
}

// ─── Effects Bus (persistent) ────────────────────────────────────────────────

let fxBus = null, fxDry, fxDelayNode, fxDelayFb, fxDelayWet, fxConvolver, fxReverbWet;

function generateIR(ctx, duration, decay) {
  const len = Math.floor(ctx.sampleRate * duration);
  const buf = ctx.createBuffer(2, len, ctx.sampleRate);
  for (let ch = 0; ch < 2; ch++) {
    const d = buf.getChannelData(ch);
    for (let i = 0; i < len; i++) {
      d[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
    }
  }
  return buf;
}

function initFxBus() {
  const ctx = getCtx();
  if (fxBus) return;

  // Input that all sources connect to
  fxBus = ctx.createGain();

  // Dry path
  fxDry = ctx.createGain();
  fxDry.gain.value = 1.0;
  fxBus.connect(fxDry);
  fxDry.connect(ctx.destination);

  // Delay path
  fxDelayNode = ctx.createDelay(2.0);
  fxDelayNode.delayTime.value = 0.3;
  fxDelayFb = ctx.createGain();
  fxDelayFb.gain.value = 0.3;
  fxDelayWet = ctx.createGain();
  fxDelayWet.gain.value = 0.0;
  fxBus.connect(fxDelayNode);
  fxDelayNode.connect(fxDelayFb);
  fxDelayFb.connect(fxDelayNode);
  fxDelayNode.connect(fxDelayWet);
  fxDelayWet.connect(ctx.destination);

  // Reverb path
  fxConvolver = ctx.createConvolver();
  fxConvolver.buffer = generateIR(ctx, 2.5, 2.2);
  fxReverbWet = ctx.createGain();
  fxReverbWet.gain.value = 0.0;
  fxBus.connect(fxConvolver);
  fxConvolver.connect(fxReverbWet);
  fxReverbWet.connect(ctx.destination);
}

function rebuildReverbIR() {
  const ctx = getCtx();
  const size = parseInt(document.getElementById('reverbSize').value, 10);
  const duration = 0.8 + size * 0.35;
  const decay    = 3.0 - size * 0.18;
  fxConvolver.buffer = generateIR(ctx, duration, decay);
}

function getOutputNode() {
  initFxBus();
  return fxBus;
}

function playChordSound(pitches, instrument, duration, startTime) {
  const ctx = getCtx();
  const now = startTime || ctx.currentTime;

  // Master bus with overall fade-out
  const master = ctx.createGain();
  master.connect(getOutputNode());
  master.gain.setValueAtTime(1, now);
  master.gain.linearRampToValueAtTime(0.0001, now + duration + 0.25);

  // Helpers
  function mkOsc(type, freq, detuneCents) {
    const o = ctx.createOscillator();
    o.type = type;
    o.frequency.value = freq * (detuneCents ? Math.pow(2, detuneCents / 1200) : 1);
    return o;
  }
  function mkGain() { const g = ctx.createGain(); g.gain.value = 0; return g; }
  function env(g, atk, dec, susLevel, rel, peak, t, dur) {
    const s = Math.max(peak * susLevel, 0.0001);
    g.gain.setValueAtTime(0.0001, t);
    g.gain.linearRampToValueAtTime(peak, t + atk);
    g.gain.exponentialRampToValueAtTime(s, t + atk + dec);
    g.gain.setValueAtTime(s, t + Math.max(dur - rel, t + atk + dec + 0.01));
    g.gain.linearRampToValueAtTime(0.0001, t + dur);
  }
  function launch(osc, g, dest, t, stop) {
    osc.connect(g); g.connect(dest);
    osc.start(t); osc.stop(stop);
  }

  // ── Pluck — Bright ────────────────────────────────────────────────────────
  if (instrument === 'pluckBright') {
    pitches.forEach((midi, i) => {
      const freq = midiToFreq(midi);
      const t = now + i * 0.022;
      const end = t + 0.65;

      // Fundamental: triangle
      const o1 = mkOsc('triangle', freq); const g1 = mkGain();
      env(g1, 0.002, 0.55, 0, 0.06, 0.30, t, 0.62);
      launch(o1, g1, master, t, end);

      // Octave sparkle: sine 2x freq, faster decay
      const o2 = mkOsc('sine', freq * 2); const g2 = mkGain();
      env(g2, 0.001, 0.20, 0, 0.02, 0.12, t, 0.22);
      launch(o2, g2, master, t, t + 0.25);
    });

  // ── Pluck — Muted ─────────────────────────────────────────────────────────
  } else if (instrument === 'pluckMuted') {
    pitches.forEach((midi, i) => {
      const freq = midiToFreq(midi);
      const t = now + i * 0.038;
      const end = t + 0.90;

      const filter = ctx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.setValueAtTime(freq * 5, t);
      filter.frequency.exponentialRampToValueAtTime(freq * 1.8, t + 0.35);
      filter.Q.value = 1.2;
      filter.connect(master);

      const o1 = mkOsc('triangle', freq);      const g1 = mkGain();
      env(g1, 0.004, 0.75, 0, 0.06, 0.35, t, 0.85);
      o1.connect(g1); g1.connect(filter);
      o1.start(t); o1.stop(end);

      // Slight body: detuned sine
      const o2 = mkOsc('sine', freq, 8);            const g2 = mkGain();
      env(g2, 0.004, 0.45, 0, 0.05, 0.12, t, 0.50);
      o2.connect(g2); g2.connect(filter);
      o2.start(t); o2.stop(t + 0.55);
    });

  // ── Pad — Warm ────────────────────────────────────────────────────────────
  } else if (instrument === 'padWarm') {
    pitches.forEach(midi => {
      const freq = midiToFreq(midi);

      // Two slightly detuned sines (chorus-like)
      [[-6, 0.15], [6, 0.15]].forEach(([cents, pk]) => {
        const o = mkOsc('sine', freq, cents); const g = mkGain();
        env(g, 0.35, 0.20, 0.78, 0.85, pk, now, duration);
        launch(o, g, master, now, now + duration + 0.1);
      });

      // Sub octave for warmth
      const osub = mkOsc('sine', freq * 0.5); const gsub = mkGain();
      env(gsub, 0.40, 0.25, 0.55, 1.0, 0.07, now, duration);
      launch(osub, gsub, master, now, now + duration + 0.1);
    });

  // ── Pad — Lush ────────────────────────────────────────────────────────────
  } else if (instrument === 'padLush') {
    pitches.forEach(midi => {
      const freq = midiToFreq(midi);

      // Three detuned oscillators with different timbres
      [[-12, 'sine', 0.11], [0, 'triangle', 0.13], [12, 'sine', 0.11]].forEach(([cents, type, pk]) => {
        const o = mkOsc(type, freq, cents); const g = mkGain();
        env(g, 0.58, 0.30, 0.68, 1.25, pk, now, duration);

        // Slow LFO tremolo on each voice
        const lfo = ctx.createOscillator();
        const lfoGain = ctx.createGain();
        lfo.type = 'sine';
        lfo.frequency.value = 0.38;
        lfoGain.gain.value = pk * 0.07;
        lfo.connect(lfoGain);
        lfoGain.connect(g.gain);
        lfo.start(now); lfo.stop(now + duration + 0.2);

        launch(o, g, master, now, now + duration + 0.2);
      });

      // Subtle high shimmer
      const oshi = mkOsc('sine', freq * 2, 5); const gshi = mkGain();
      env(gshi, 0.65, 0.25, 0.40, 1.3, 0.04, now, duration);
      launch(oshi, gshi, master, now, now + duration + 0.2);
    });

  // ── Keys — Electric ───────────────────────────────────────────────────────
  } else if (instrument === 'keysElectric') {
    pitches.forEach(midi => {
      const freq = midiToFreq(midi);

      // Body: triangle (the sustained tone)
      const o1 = mkOsc('triangle', freq);  const g1 = mkGain();
      env(g1, 0.010, 0.22, 0.42, 0.40, 0.24, now, duration);
      launch(o1, g1, master, now, now + duration + 0.05);

      // Slight detune for warmth
      const o1b = mkOsc('triangle', freq, -5); const g1b = mkGain();
      env(g1b, 0.012, 0.20, 0.35, 0.40, 0.08, now, duration);
      launch(o1b, g1b, master, now, now + duration + 0.05);

      // Attack transient: higher partial (EP "tine" click)
      const o2 = mkOsc('sine', freq * 4.97); const g2 = mkGain();
      env(g2, 0.003, 0.14, 0, 0.01, 0.16, now, 0.16);
      launch(o2, g2, master, now, now + 0.18);
    });

  // ── Keys — Bell ───────────────────────────────────────────────────────────
  } else if (instrument === 'keysBell') {
    pitches.forEach(midi => {
      const freq = midiToFreq(midi);

      // Inharmonic partials characteristic of bells/metallophones
      [
        [1.000, 0.30, 1.60],
        [2.756, 0.14, 0.95],
        [5.404, 0.07, 0.55],
        [8.933, 0.03, 0.30],
      ].forEach(([mult, peak, decay]) => {
        const o = mkOsc('sine', freq * mult); const g = mkGain();
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(peak, now + 0.002);
        g.gain.exponentialRampToValueAtTime(0.0001, now + decay);
        launch(o, g, master, now, now + decay + 0.05);
      });
    });
  }
}

// ─── Grooves ─────────────────────────────────────────────────────────────────
// Each groove defines one or more sound slots per bar.
// slot: { t: startOffsetWithinBar (seconds), dur: playDuration (seconds) }

const GROOVES = {
  straight: {
    name: 'Straight',
    slots(barDur)      { return [{ t: 0, dur: barDur * 0.98 }]; },
  },
  stab: {
    name: 'Stab',
    slots(barDur)      { return [{ t: 0, dur: barDur * 0.18 }]; },
  },
  halfBar: {
    name: 'Half Bar',
    slots(barDur)      { return [{ t: 0, dur: barDur * 0.46 }]; },
  },
  offbeat: {
    name: 'Offbeat',
    // chord enters on beat 2 — creates a syncopated push feel
    slots(barDur)      { return [{ t: barDur * 0.25, dur: barDur * 0.70 }]; },
  },
  pump: {
    name: 'Pump',
    // two hits per bar: beat 1 and beat 3
    slots(barDur)      {
      const h = barDur * 0.5;
      return [{ t: 0, dur: h * 0.84 }, { t: h, dur: h * 0.84 }];
    },
  },
};

// ─── State ────────────────────────────────────────────────────────────────────

let currentProgression = [];
let playbackTimer = null;
let selectedPreset = null;
let isPlaying = false;
let playbackTimeouts = [];
let currentPlayIndex = -1;

// ─── UI Helpers ───────────────────────────────────────────────────────────────

function val(id) { return document.getElementById(id).value; }

function buildPiano() {
  const piano = document.getElementById('piano');
  piano.innerHTML = '';
  // Two octaves starting from C3
  const layout = [0,1,0,1,0,0,1,0,1,0,1,0]; // 0=white,1=black for one octave
  for (let oct = 3; oct <= 5; oct++) {
    for (let i = 0; i < 12; i++) {
      const key = document.createElement('div');
      const midi = oct * 12 + i;
      key.className = `key ${layout[i] === 0 ? 'white' : 'black'}`;
      key.dataset.midi = midi;
      key.dataset.note = NOTE_NAMES[i];
      piano.appendChild(key);
    }
  }
}

function lightPiano(noteNames, rootName) {
  document.querySelectorAll('.key').forEach(k => {
    k.classList.remove('lit-chord','lit-root');
    if (noteNames.includes(k.dataset.note)) {
      if (k.dataset.note === rootName) k.classList.add('lit-root');
      else k.classList.add('lit-chord');
    }
  });
}

function clearPiano() {
  document.querySelectorAll('.key').forEach(k => k.classList.remove('lit-chord','lit-root'));
}

function renderChordCards(progression) {
  const grid = document.getElementById('progressionGrid');
  grid.innerHTML = '';

  progression.forEach((chord, idx) => {
    const card = document.createElement('div');
    card.className = 'chord-card';
    card.dataset.idx = idx;

    const indicator = document.createElement('div');
    indicator.className = 'play-indicator';
    card.appendChild(indicator);

    card.innerHTML += `
      <div class="chord-numeral">${chord.roman.toUpperCase()}</div>
      <div class="chord-name">${chord.chordRootName}${chord.quality}</div>
      <div class="chord-quality">${chord.label}</div>
      <div class="chord-notes">${chord.noteNames.join(' · ')}</div>
    `;
    card.appendChild(indicator);

    card.addEventListener('click', () => {
      stopPlayback();
      highlightCard(idx);
      lightPiano(chord.noteNames, chord.chordRootName);
      playChordSound(chord.pitches, val('instrument'), 2.0);
    });

    grid.appendChild(card);
  });
}

function highlightCard(idx) {
  document.querySelectorAll('.chord-card').forEach((c, i) => {
    c.classList.remove('playing','queued');
    if (i === idx) c.classList.add('playing');
  });
  currentPlayIndex = idx;
}

function clearHighlights() {
  document.querySelectorAll('.chord-card').forEach(c => c.classList.remove('playing','queued'));
  currentPlayIndex = -1;
}

function updateInfoBar() {
  const root = val('rootKey');
  const scaleKey = val('scale');
  const genreKey = val('genre');
  document.getElementById('genreDisplay').textContent = GENRES[genreKey].name;
  document.getElementById('keyDisplay').textContent = root;
  document.getElementById('scaleDisplay').textContent = SCALES[scaleKey].name;
  document.getElementById('chordCount').textContent = currentProgression.length || '—';
}

function getFilteredPresets() {
  const genre = val('genre');
  const bars  = parseInt(val('progLength'), 10);
  return PRESETS.filter(p => (genre === 'all' || p.genre === genre) && p.bars === bars);
}

function setStatus(msg) {
  document.getElementById('statusText').textContent = msg;
}

// ─── Playback ─────────────────────────────────────────────────────────────────

function stopPlayback() {
  playbackTimeouts.forEach(t => clearTimeout(t));
  playbackTimeouts = [];
  isPlaying = false;
  clearHighlights();
  clearPiano();
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('btnPlay').disabled = currentProgression.length === 0;
  document.getElementById('btnStop').disabled = true;
  setStatus('Stopped');
}

function playProgression() {
  if (isPlaying) stopPlayback();
  if (!currentProgression.length) return;

  getCtx(); // ensure context is resumed on user gesture
  isPlaying = true;
  document.getElementById('btnPlay').disabled = true;
  document.getElementById('btnStop').disabled = false;

  const bpm        = parseInt(val('tempo'), 10);
  const secPerBeat = 60 / bpm;
  const barDur     = secPerBeat * 4;          // one bar = 4 beats
  const totalDur   = barDur * currentProgression.length;
  const instrument = val('instrument');
  const groove     = GROOVES[val('groove')] || GROOVES.straight;
  const ctx        = getCtx();

  currentProgression.forEach((chord, idx) => {
    const barStart = idx * barDur;

    // Schedule each groove slot for this chord
    groove.slots(barDur, idx).forEach(slot => {
      const audioStart = ctx.currentTime + barStart + slot.t;
      playChordSound(chord.pitches, instrument, slot.dur, audioStart);
    });

    // UI highlight fires at bar start
    const t = setTimeout(() => {
      highlightCard(idx);
      lightPiano(chord.noteNames, chord.chordRootName);
      setStatus(`Playing: ${chord.chordRootName}${chord.quality} (${chord.label})`);
      document.getElementById('progressFill').style.width =
        (((idx + 1) / currentProgression.length) * 100) + '%';
    }, barStart * 1000);
    playbackTimeouts.push(t);
  });

  // End
  const endT = setTimeout(() => {
    isPlaying = false;
    clearHighlights();
    clearPiano();
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('btnPlay').disabled = false;
    document.getElementById('btnStop').disabled = true;
    setStatus('Playback complete');
  }, totalDur * 1000 + 500);
  playbackTimeouts.push(endT);
}

// ─── Voice Leading ────────────────────────────────────────────────────────────
// Chooses the inversion of each chord that minimises movement from the
// previous chord, keeping all notes within a comfortable keyboard range.

function voiceLeadProgression(chords) {
  if (!chords.length) return chords;

  const MIN = 36;  // C3 in our MIDI system
  const MAX = 78;  // F#6 — hard ceiling

  // All valid inversions of a pitch set, across octave shifts
  function allInversions(pitches) {
    const sorted = [...pitches].sort((a, b) => a - b);
    const n = sorted.length;
    const out = [];
    for (let inv = 0; inv < n; inv++) {
      const base = [
        ...sorted.slice(inv),
        ...sorted.slice(0, inv).map(p => p + 12),
      ];
      for (let shift = -2; shift <= 2; shift++) {
        const cand = base.map(p => p + shift * 12);
        if (cand[0] >= MIN && cand[cand.length - 1] <= MAX) out.push(cand);
      }
    }
    return out.length ? out : [sorted]; // fallback: root position
  }

  // Score a candidate voicing: minimise voice movement + drift from target
  function scoreVoicing(cand, prev, target) {
    const center = cand.reduce((s, p) => s + p, 0) / cand.length;
    // Sum of each note's distance to the nearest note in the previous chord
    const movement = cand.reduce((s, p) => {
      const closest = Math.min(...prev.map(pp => Math.abs(p - pp)));
      return s + closest;
    }, 0);
    const drift    = Math.abs(center - target) * 0.7;
    const spread   = cand[cand.length - 1] - cand[0];
    const widePen  = Math.max(0, spread - 15) * 0.5;
    return movement + drift + widePen;
  }

  // Anchor target: center of the first chord in its current (root) position
  const firstCenter = chords[0].pitches.reduce((s, p) => s + p, 0) / chords[0].pitches.length;
  const TARGET = Math.max(MIN + 8, Math.min(MAX - 8, firstCenter));

  // Pick first chord inversion closest to the target center
  const firstInvs = allInversions(chords[0].pitches);
  const firstBest = firstInvs.reduce((best, cand) => {
    const c = cand.reduce((s, p) => s + p, 0) / cand.length;
    const b = best.reduce((s, p) => s + p, 0) / best.length;
    return Math.abs(c - TARGET) < Math.abs(b - TARGET) ? cand : best;
  });

  const result = [{
    ...chords[0],
    pitches: firstBest,
    noteNames: firstBest.map(p => NOTE_NAMES[((p % 12) + 12) % 12]),
  }];

  for (let i = 1; i < chords.length; i++) {
    const invs = allInversions(chords[i].pitches);
    const prev = result[i - 1].pitches;
    let best = invs[0]; let bestScore = Infinity;
    for (const cand of invs) {
      const s = scoreVoicing(cand, prev, TARGET);
      if (s < bestScore) { bestScore = s; best = cand; }
    }
    result.push({
      ...chords[i],
      pitches: best,
      noteNames: best.map(p => NOTE_NAMES[((p % 12) + 12) % 12]),
    });
  }
  return result;
}

// ─── Generation ───────────────────────────────────────────────────────────────

function generateFromDegrees(degrees) {
  const root    = val('rootKey');
  const scaleKey = val('scale');
  const voicing = val('voicing');
  const octave  = val('octave');

  // Clamp degrees to valid scale range
  const maxDegree = SCALES[scaleKey].steps.length - 1;
  const validDegrees = degrees.map(d => Math.min(d, maxDegree));

  const rawChords = validDegrees.map(d => buildChord(root, d, scaleKey, voicing, octave));
  currentProgression = voiceLeadProgression(rawChords);
  renderChordCards(currentProgression);
  updateInfoBar();
  document.getElementById('btnPlay').disabled = false;
  setStatus('Click a chord to preview, or Play All');
}

function generateRandom() {
  const filtered = getFilteredPresets();
  const preset = filtered[Math.floor(Math.random() * filtered.length)];
  selectedPreset = null;
  document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('active'));
  generateFromDegrees(preset.degrees);
  const genreName = preset.genre ? GENRES[preset.genre].name : '';
  setStatus(`Generated: "${preset.name}"${genreName ? ' (' + genreName + ')' : ''} — click Play or a chord`);
}

// ─── Presets ─────────────────────────────────────────────────────────────────

function buildPresets() {
  const list = document.getElementById('presetList');
  const descEl = document.getElementById('genreDesc');
  const genre = val('genre');
  const filtered = getFilteredPresets();

  list.innerHTML = '';

  // Show genre description
  if (genre !== 'all' && GENRES[genre].desc) {
    const g = GENRES[genre];
    descEl.innerHTML = g.desc +
      '<div class="genre-tags">' + g.tags.map(t => `<span class="genre-tag">${t}</span>`).join('') + '</div>';
    descEl.style.display = 'block';
  } else {
    descEl.style.display = 'none';
  }

  filtered.forEach((preset, idx) => {
    const chip = document.createElement('div');
    chip.className = 'preset-chip';
    chip.textContent = preset.name;
    chip.title = preset.label + (preset.genre ? ' — ' + GENRES[preset.genre].name : '');
    chip.addEventListener('click', () => {
      stopPlayback();
      document.querySelectorAll('.preset-chip').forEach(c => c.classList.remove('active'));
      chip.classList.add('active');
      selectedPreset = idx;
      generateFromDegrees(preset.degrees);
    });
    list.appendChild(chip);
  });
}

function applyGenreDefaults(genre) {
  if (genre === 'all') return;
  const d = GENRES[genre].defaults;
  if (d.scale)      document.getElementById('scale').value      = d.scale;
  if (d.voicing)    document.getElementById('voicing').value     = d.voicing;
  if (d.instrument) document.getElementById('instrument').value  = d.instrument;
  if (d.tempo) {
    document.getElementById('tempo').value = d.tempo;
    document.getElementById('tempoVal').textContent = d.tempo;
  }
}

// ─── Bootstrap ────────────────────────────────────────────────────────────────

buildPiano();
buildPresets();

document.getElementById('tempo').addEventListener('input', e => {
  document.getElementById('tempoVal').textContent = e.target.value;
});

// Genre change: rebuild presets, apply genre defaults, auto-generate
document.getElementById('genre').addEventListener('change', () => {
  stopPlayback();
  const genre = val('genre');
  applyGenreDefaults(genre);
  buildPresets();
  generateRandom();
});

document.getElementById('btnGenerate').addEventListener('click', () => {
  stopPlayback();
  generateRandom();
});

document.getElementById('btnPlay').addEventListener('click', playProgression);
document.getElementById('btnStop').addEventListener('click', stopPlayback);

document.getElementById('btnShuffle').addEventListener('click', () => {
  stopPlayback();
  // Pick random key — keep genre-appropriate scale
  const keys = NOTE_NAMES;
  document.getElementById('rootKey').value = keys[Math.floor(Math.random() * keys.length)];
  const genre = val('genre');
  if (genre === 'all') {
    const scaleIds = Object.keys(SCALES);
    document.getElementById('scale').value = scaleIds[Math.floor(Math.random() * scaleIds.length)];
  }
  generateRandom();
});

// Re-render on settings change (without auto-play)
['rootKey','scale','voicing','octave'].forEach(id => {
  document.getElementById(id).addEventListener('change', () => {
    if (currentProgression.length) {
      stopPlayback();
      const degrees = currentProgression.map(c => c.degree);
      generateFromDegrees(degrees);
    }
  });
});

// Length change: rebuild preset list (different bar presets) and re-generate
document.getElementById('progLength').addEventListener('change', () => {
  stopPlayback();
  buildPresets();
  generateRandom();
});

// ─── Effects controls ─────────────────────────────────────────────────────────

document.getElementById('delayMix').addEventListener('input', e => {
  document.getElementById('delayMixVal').textContent = e.target.value + '%';
  initFxBus();
  fxDelayWet.gain.value = e.target.value / 100;
});

document.getElementById('delayTime').addEventListener('input', e => {
  document.getElementById('delayTimeVal').textContent = e.target.value + 'ms';
  initFxBus();
  fxDelayNode.delayTime.value = e.target.value / 1000;
});

document.getElementById('delayFeedback').addEventListener('input', e => {
  document.getElementById('delayFeedbackVal').textContent = e.target.value + '%';
  initFxBus();
  fxDelayFb.gain.value = e.target.value / 100;
});

document.getElementById('reverbMix').addEventListener('input', e => {
  document.getElementById('reverbMixVal').textContent = e.target.value + '%';
  initFxBus();
  fxReverbWet.gain.value = e.target.value / 100;
});

document.getElementById('reverbSize').addEventListener('input', e => {
  document.getElementById('reverbSizeVal').textContent = e.target.value;
  initFxBus();
  rebuildReverbIR();
});

// Initial generation
generateFromDegrees(PRESETS[0].degrees);
document.querySelector('.preset-chip').classList.add('active');
</script>
</body>
</html>
